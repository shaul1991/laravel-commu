# ==========================================
# 로컬 개발 인프라
# ==========================================

services:
  # ==========================================
  # WAS (PHP-FPM + Supervisor)
  # ==========================================
  was:
    build:
      context: ./was
      dockerfile: Dockerfile
    container_name: ${COMPOSE_PROJECT_NAME:-laravel}_was
    restart: unless-stopped
    environment:
      APP_ENV: ${APP_ENV:-local}
      DB_HOST: postgres
      DB_PORT: 5432
      REDIS_HOST: redis
      REDIS_PORT: 6379
      XDEBUG_MODE: ${XDEBUG_MODE:-off}
    ports:
      - "${WAS_PORT:-9002}:9000"
    volumes:
      - ../:/var/www/html
      - ./was/php.ini:/usr/local/etc/php/conf.d/custom.ini:ro
      - ./was/xdebug.ini:/usr/local/etc/php/conf.d/xdebug.ini:ro
      - ./was/supervisord.conf:/etc/supervisord.conf:ro
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - app_network
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

  # ==========================================
  # Nginx (웹서버)
  # ==========================================
  nginx:
    image: nginx:${NGINX_VERSION:-alpine}
    container_name: ${COMPOSE_PROJECT_NAME:-laravel}_nginx
    restart: unless-stopped
    ports:
      - "${NGINX_PORT:-80}:80"
    volumes:
      - ../:/var/www/html:ro
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - app_network
    depends_on:
      - was
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/up"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ==========================================
  # PostgreSQL
  # ==========================================
  postgres:
    image: postgres:${POSTGRES_VERSION:-18-alpine}
    container_name: ${COMPOSE_PROJECT_NAME:-laravel}_postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-laravel}
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - app_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==========================================
  # Redis
  # ==========================================
  redis:
    image: redis:${REDIS_VERSION:-8-alpine}
    container_name: ${COMPOSE_PROJECT_NAME:-laravel}_redis
    restart: unless-stopped
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    networks:
      - app_network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==========================================
  # MongoDB
  # ==========================================
  mongodb:
    image: mongo:${MONGODB_VERSION:-8}
    container_name: ${COMPOSE_PROJECT_NAME:-laravel}_mongodb
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGODB_ROOT_USERNAME:-root}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGODB_ROOT_PASSWORD:-root}
    ports:
      - "${MONGODB_PORT:-27017}:27017"
    volumes:
      - mongo_data:/data/db
    networks:
      - app_network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==========================================
  # MinIO (S3 호환 스토리지)
  # ==========================================
  minio:
    image: minio/minio:${MINIO_VERSION:-latest}
    container_name: ${COMPOSE_PROJECT_NAME:-laravel}_minio
    restart: unless-stopped
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
    ports:
      - "${MINIO_API_PORT:-9000}:9000"
      - "${MINIO_CONSOLE_PORT:-9001}:9001"
    volumes:
      - minio_data:/data
    command: server /data --console-address ":9001"
    networks:
      - app_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3

# ==========================================
# 네트워크
# ==========================================
networks:
  app_network:
    name: ${NETWORK_NAME:-laravel_network}
    driver: bridge

# ==========================================
# 볼륨
# ==========================================
volumes:
  postgres_data:
    name: ${COMPOSE_PROJECT_NAME:-laravel}_postgres_data
  redis_data:
    name: ${COMPOSE_PROJECT_NAME:-laravel}_redis_data
  mongo_data:
    name: ${COMPOSE_PROJECT_NAME:-laravel}_mongo_data
  minio_data:
    name: ${COMPOSE_PROJECT_NAME:-laravel}_minio_data
