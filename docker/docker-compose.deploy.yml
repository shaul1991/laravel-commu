# ==========================================
# 배포용 Docker Compose (prod/dev 통합)
# DEPLOY_ENV 환경변수로 환경 구분
# - prod: Blue-Green 배포 (blue/green 서비스)
# - dev: 단일 컨테이너 배포 (dev 서비스)
# ==========================================

services:
  # ==========================================
  # Blue 컨테이너 (prod 환경)
  # ==========================================
  blue:
    image: laravel-commu-base:latest
    container_name: laravel-commu-blue
    restart: unless-stopped
    profiles:
      - prod
    env_file:
      - ${ENV_FILE:-.env.prod}
    ports:
      - "10000:80"
    volumes:
      # 애플리케이션 코드
      - ${APP_PATH:-/var/www/laravel-commu}:/var/www/html
      # 공유 storage (호스트 디렉토리 - blue/green 공유)
      - ${STORAGE_PATH:-/var/www/laravel-commu-storage}:/var/www/html/storage
      # 설정 파일
      - ${APP_PATH:-/var/www/laravel-commu}/docker/was/php.ini:/usr/local/etc/php/conf.d/custom.ini:ro
      - ${APP_PATH:-/var/www/laravel-commu}/docker/prod/opcache.ini:/usr/local/etc/php/conf.d/opcache.ini:ro
      - ${APP_PATH:-/var/www/laravel-commu}/docker/prod/php-fpm.conf:/usr/local/etc/php-fpm.d/www.conf:ro
      - ${APP_PATH:-/var/www/laravel-commu}/docker/prod/nginx.conf:/etc/nginx/nginx.conf:ro
      - ${APP_PATH:-/var/www/laravel-commu}/docker/prod/default.conf:/etc/nginx/http.d/default.conf:ro
      - ${APP_PATH:-/var/www/laravel-commu}/docker/prod/supervisord.conf:/etc/supervisord.conf:ro
    networks:
      - laravel_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/up"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  # ==========================================
  # Green 컨테이너 (prod 환경)
  # ==========================================
  green:
    image: laravel-commu-base:latest
    container_name: laravel-commu-green
    restart: unless-stopped
    profiles:
      - prod
    env_file:
      - ${ENV_FILE:-.env.prod}
    ports:
      - "10001:80"
    volumes:
      # 애플리케이션 코드
      - ${APP_PATH:-/var/www/laravel-commu}:/var/www/html
      # 공유 storage (호스트 디렉토리 - blue/green 공유)
      - ${STORAGE_PATH:-/var/www/laravel-commu-storage}:/var/www/html/storage
      # 설정 파일
      - ${APP_PATH:-/var/www/laravel-commu}/docker/was/php.ini:/usr/local/etc/php/conf.d/custom.ini:ro
      - ${APP_PATH:-/var/www/laravel-commu}/docker/prod/opcache.ini:/usr/local/etc/php/conf.d/opcache.ini:ro
      - ${APP_PATH:-/var/www/laravel-commu}/docker/prod/php-fpm.conf:/usr/local/etc/php-fpm.d/www.conf:ro
      - ${APP_PATH:-/var/www/laravel-commu}/docker/prod/nginx.conf:/etc/nginx/nginx.conf:ro
      - ${APP_PATH:-/var/www/laravel-commu}/docker/prod/default.conf:/etc/nginx/http.d/default.conf:ro
      - ${APP_PATH:-/var/www/laravel-commu}/docker/prod/supervisord.conf:/etc/supervisord.conf:ro
    networks:
      - laravel_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/up"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  # ==========================================
  # Dev 컨테이너 (dev 환경)
  # ==========================================
  dev:
    image: laravel-commu-base:latest
    container_name: laravel-commu-dev
    restart: unless-stopped
    profiles:
      - dev
    env_file:
      - ${ENV_FILE:-.env.dev}
    ports:
      - "10100:80"
    volumes:
      # 애플리케이션 코드
      - ${APP_PATH:-/var/www/laravel-commu-dev}:/var/www/html
      # 공유 storage (호스트 디렉토리)
      - ${STORAGE_PATH:-/var/www/laravel-commu-dev-storage}:/var/www/html/storage
      # 설정 파일
      - ${APP_PATH:-/var/www/laravel-commu-dev}/docker/was/php.ini:/usr/local/etc/php/conf.d/custom.ini:ro
      - ${APP_PATH:-/var/www/laravel-commu-dev}/docker/prod/opcache.ini:/usr/local/etc/php/conf.d/opcache.ini:ro
      - ${APP_PATH:-/var/www/laravel-commu-dev}/docker/prod/php-fpm.conf:/usr/local/etc/php-fpm.d/www.conf:ro
      - ${APP_PATH:-/var/www/laravel-commu-dev}/docker/prod/nginx.conf:/etc/nginx/nginx.conf:ro
      - ${APP_PATH:-/var/www/laravel-commu-dev}/docker/prod/default.conf:/etc/nginx/http.d/default.conf:ro
      - ${APP_PATH:-/var/www/laravel-commu-dev}/docker/prod/supervisord.conf:/etc/supervisord.conf:ro
    networks:
      - laravel_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/up"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    extra_hosts:
      # Dev 데이터베이스 컨테이너 연결 (호스트 네트워크 접근)
      - "host.docker.internal:host-gateway"

# ==========================================
# 네트워크
# ==========================================
networks:
  laravel_network:
    external: true
    name: ${NETWORK_NAME:-laravel_network}

# ==========================================
# 볼륨
# ==========================================
# storage는 호스트 디렉토리 바인드 마운트 사용 (STORAGE_PATH 환경변수)
# prod 기본값: /var/www/laravel-commu-storage
# dev 기본값: /var/www/laravel-commu-dev-storage
