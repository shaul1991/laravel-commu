# ==========================================
# 프로덕션 Docker Compose
# Blue-Green 배포용 (볼륨 마운트 방식)
# ==========================================

services:
  # ==========================================
  # Blue 컨테이너
  # ==========================================
  blue:
    image: laravel-commu-base:latest
    container_name: laravel-commu-blue
    restart: unless-stopped
    env_file:
      - ${ENV_FILE:-.env.prod}
    ports:
      - "10000:80"
    volumes:
      # 애플리케이션 코드
      - ${APP_PATH:-/var/www/laravel-commu}:/var/www/html
      # 공유 storage (호스트 디렉토리 - blue/green 공유)
      - ${STORAGE_PATH:-/var/www/laravel-commu-storage}:/var/www/html/storage
      # 설정 파일
      - ${APP_PATH:-/var/www/laravel-commu}/docker/was/php.ini:/usr/local/etc/php/conf.d/custom.ini:ro
      - ${APP_PATH:-/var/www/laravel-commu}/docker/prod/opcache.ini:/usr/local/etc/php/conf.d/opcache.ini:ro
      - ${APP_PATH:-/var/www/laravel-commu}/docker/prod/php-fpm.conf:/usr/local/etc/php-fpm.d/www.conf:ro
      - ${APP_PATH:-/var/www/laravel-commu}/docker/prod/nginx.conf:/etc/nginx/nginx.conf:ro
      - ${APP_PATH:-/var/www/laravel-commu}/docker/prod/default.conf:/etc/nginx/http.d/default.conf:ro
      - ${APP_PATH:-/var/www/laravel-commu}/docker/prod/supervisord.conf:/etc/supervisord.conf:ro
    networks:
      - laravel_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/up"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  # ==========================================
  # Green 컨테이너
  # ==========================================
  green:
    image: laravel-commu-base:latest
    container_name: laravel-commu-green
    restart: unless-stopped
    env_file:
      - ${ENV_FILE:-.env.prod}
    ports:
      - "10001:80"
    volumes:
      # 애플리케이션 코드
      - ${APP_PATH:-/var/www/laravel-commu}:/var/www/html
      # 공유 storage (호스트 디렉토리 - blue/green 공유)
      - ${STORAGE_PATH:-/var/www/laravel-commu-storage}:/var/www/html/storage
      # 설정 파일
      - ${APP_PATH:-/var/www/laravel-commu}/docker/was/php.ini:/usr/local/etc/php/conf.d/custom.ini:ro
      - ${APP_PATH:-/var/www/laravel-commu}/docker/prod/opcache.ini:/usr/local/etc/php/conf.d/opcache.ini:ro
      - ${APP_PATH:-/var/www/laravel-commu}/docker/prod/php-fpm.conf:/usr/local/etc/php-fpm.d/www.conf:ro
      - ${APP_PATH:-/var/www/laravel-commu}/docker/prod/nginx.conf:/etc/nginx/nginx.conf:ro
      - ${APP_PATH:-/var/www/laravel-commu}/docker/prod/default.conf:/etc/nginx/http.d/default.conf:ro
      - ${APP_PATH:-/var/www/laravel-commu}/docker/prod/supervisord.conf:/etc/supervisord.conf:ro
    networks:
      - laravel_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/up"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

# ==========================================
# 네트워크
# ==========================================
networks:
  laravel_network:
    external: true
    name: ${NETWORK_NAME:-laravel_network}

# ==========================================
# 볼륨
# ==========================================
# storage는 호스트 디렉토리 바인드 마운트 사용 (STORAGE_PATH 환경변수)
# 기본값: /var/www/laravel-commu-storage
