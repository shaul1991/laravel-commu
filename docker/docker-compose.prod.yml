# ==========================================
# 프로덕션 Docker Compose
# Blue-Green 배포용
# ==========================================

services:
  # ==========================================
  # Blue 컨테이너
  # ==========================================
  blue:
    build:
      context: ..
      dockerfile: docker/Dockerfile.prod
    container_name: laravel-commu-blue
    restart: unless-stopped
    environment:
      APP_ENV: production
      APP_DEBUG: "false"
      DB_HOST: ${DB_HOST:-192.168.0.26}
      DB_PORT: ${DB_PORT:-5432}
      DB_DATABASE: ${DB_DATABASE:-laravel}
      DB_USERNAME: ${DB_USERNAME:-postgres}
      DB_PASSWORD: ${DB_PASSWORD}
      REDIS_HOST: ${REDIS_HOST:-192.168.0.26}
      REDIS_PORT: ${REDIS_PORT:-6379}
    ports:
      - "10000:80"
    volumes:
      - app_storage:/var/www/html/storage/app
      - app_logs:/var/www/html/storage/logs
    networks:
      - laravel_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/up"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  # ==========================================
  # Green 컨테이너
  # ==========================================
  green:
    build:
      context: ..
      dockerfile: docker/Dockerfile.prod
    container_name: laravel-commu-green
    restart: unless-stopped
    environment:
      APP_ENV: production
      APP_DEBUG: "false"
      DB_HOST: ${DB_HOST:-192.168.0.26}
      DB_PORT: ${DB_PORT:-5432}
      DB_DATABASE: ${DB_DATABASE:-laravel}
      DB_USERNAME: ${DB_USERNAME:-postgres}
      DB_PASSWORD: ${DB_PASSWORD}
      REDIS_HOST: ${REDIS_HOST:-192.168.0.26}
      REDIS_PORT: ${REDIS_PORT:-6379}
    ports:
      - "10001:80"
    volumes:
      - app_storage:/var/www/html/storage/app
      - app_logs:/var/www/html/storage/logs
    networks:
      - laravel_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/up"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

# ==========================================
# 네트워크
# ==========================================
networks:
  laravel_network:
    external: true
    name: ${NETWORK_NAME:-laravel_network}

# ==========================================
# 볼륨 (영구 스토리지)
# ==========================================
volumes:
  app_storage:
    name: laravel-commu_storage
  app_logs:
    name: laravel-commu_logs
